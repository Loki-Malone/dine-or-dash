// Generated by CoffeeScript 2.5.1
(function() {
  // Initializing global variables
  var alias, city, cityCount, counter, delay, dislikedRestaurants, geoConfirm, geoID, geolocate, getCoordinates, getKeys, displayCard, getReviews, id, lat, long, maps, nearbyRestaurants, offset, picURL, pos, randomSelection, restDiv, restaurantArray, restaurantPhotos, searchRestaurants, searchRestaurantsByID, selection, sendInfo, setCity, yelp, displayCardNoAPI;

  alias = this;

  id = this;

  picURL = this;

  restDiv = $(".restaurants");

  pos = this;

  yelp = this;

  maps = this;

  lat = this;

  long = this;

  city = this;

  cityCount = this;

  offset = 0;

  counter = 0;

  restaurantArray = [];

  geoConfirm = this;

  delay = function(ms, func) {
    return setTimeout(func, ms);
  };

  geoID = this;

  selection = "";

  // Searches restaurants based on the users entry
  searchRestaurants = function() {
    return $.ajax({
      url: `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?location=${city}&categories=restaurants&limit=50&offset=${offset}`,
      method: "GET",
      cache: true,
      headers: {
        "Authorization": yelp
      }
    }).then(function(res) {
      var count, dislikeBtn, likeBtn;
      console.log(restaurantArray);
      count = 0;
      while (count <= 50) {
        if (count === 50) {
          offset = offset + 50;
          return delay(1000, function() {
            return searchRestaurants();
          });
        } else {
          if (res.businesses[count] !== void 0) {
            restaurantArray.push(res.businesses[count]);
            count++;
          } else if (res.businesses[count] === void 0) {
            return;
          }
        }
        if (offset >= 100) {
          break;
        }
      }
      randomSelection();
      id = selection[0].id;
      displayCard(id);
      likeBtn = $("<button>").text("Dine!");
      dislikeBtn = $("<button>").text("Dash!");
      likeBtn.off('click').click(function(event) {
        if (selection != "") {
          console.log(selection);
          var id, name, picURL, yelp;
          event.preventDefault();
          id = selection[0].id;
          name = selection[0].name;
          picURL = selection[0].image_url;
          yelp = selection[0].url;
          sendInfo(id, name, picURL, yelp);
        }
        else {
          var id, name, picURL, yelp;
          event.preventDefault();
          id = restaurantArray[0].id;
          name = restaurantArray[0].name;
          picURL = restaurantArray[0].image_url;
          yelp = restaurantArray[0].url;
          restaurantArray.splice(0, 1);
          sendInfo(id, name, picURL, yelp);
        }
      });
      dislikeBtn.off('click').click(function(event) {
        var id;
        event.preventDefault();
        randomSelection();
        id = selection[0].id;
        displayCard(id);
      });
      likeBtn.appendTo(restDiv);
      return dislikeBtn.appendTo(restDiv);
    });
  };

  
  // Nearby restaurants search function
  nearbyRestaurants = function() {
    return $.ajax({
      url: `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?latitude=${lat}&longitude=${long}&categories=restaurants&limit=50&offset=${offset}`,
      method: "GET",
      cache: true,
      headers: {
        "Authorization": yelp
      }
    }).then(function(res) {
      var count, dislikeBtn, likeBtn;
      $("#proximity").remove();
      console.log(restaurantArray);
      count = 0;
      while (count <= 50) {
        if (count === 50) {
          offset = offset + 50;
          return delay(1000, function() {
            return nearbyRestaurants();
          });
        } else {
          if (res.businesses[count] !== void 0) {
            restaurantArray.push(res.businesses[count]);
            count++;
          } else if (res.businesses[count] === void 0) {
            return;
          }
        }
        if (offset >= 100) {
          break;
        }
      }
      randomSelection();
      id = selection[0].id;
      displayCard(id);
      likeBtn = $("<button>").text("Dine!");
      dislikeBtn = $("<button>").text("Dash!");
      likeBtn.off('click').click(function(event) {
        if (selection != "") {
          console.log(selection);
          var id, name, picURL, yelp;
          event.preventDefault();
          id = selection[0].id;
          name = selection[0].name;
          picURL = selection[0].image_url;
          yelp = selection[0].url;
          sendInfo(id, name, picURL, yelp);
        }
        else {
          var id, name, picURL, yelp;
          event.preventDefault();
          id = restaurantArray[0].id;
          name = restaurantArray[0].name;
          picURL = restaurantArray[0].image_url;
          yelp = restaurantArray[0].url;
          restaurantArray.splice(0, 1);
          sendInfo(id, name, picURL, yelp);
        }
      });
      dislikeBtn.off('click').click(function(event) {
        var id;
        event.preventDefault();
        randomSelection();
        id = selection[0].id;
        displayCard(id);
      });
      likeBtn.appendTo(restDiv);
      return dislikeBtn.appendTo(restDiv);
    });
  };

  
  // Returns a city by using the id stored in mysql. Will want to pull the id from within this function likely
  searchRestaurantsByID = function() {
    return $.ajax({
      url: `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/${id}`,
      method: "GET",
      cache: true,
      headers: {
        "Authorization": yelp
      }
    }).then(function(res) {
      return console.log(res);
    });
  };

  // Displays the card handlebar w/out api call
  displayCard = function(id) {
    console.log(id);
    console.log(selection);
    // get the template
    var source = $("#card-hbs").html();
    // compile template:
    var template = Handlebars.compile(source)
    // apply template:
    var info = {
      imageURL: selection[0].image_url,
      name: selection[0].name,
      yelp: selection[0].yelp_url,
      search: "Get Info"
    };
    var context = template(info);
    console.log(context);
    // add result to the page:
    $('.hbs-container').empty().append(context);
  };

  // Gets photos of the restaurant
  restaurantPhotos = function() {
    return $.ajax({
      url: `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/${alias}`,
      method: "GET",
      cache: true,
      headers: {
        "Authorization": yelp
      }
    }).then(function(res) {
      return console.log(res);
    });
  };

  // Gets reviews for the restaurant
  getReviews = function() {
    return $.ajax({
      url: `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/${alias}/reviews`,
      method: "GET",
      cache: true,
      headers: {
        "Authorization": yelp
      }
    }).then(function(res) {
      return console.log(res);
    });
  };

  // Gets the users current location to make a call to yelp for nearby restaurants
  getCoordinates = function() {
    var error, options, success;
    options = {
      enableHighAccuracy: false,
      timeout: 5000
    };
    error = function(err) {
      return console.log("ERROR(" + err.code + "): " + err.message);
    };
    success = function(position) {
      pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      lat = pos.lat;
      long = pos.lng;
      nearbyRestaurants();
      return navigator.geolocation.clearWatch(id);
    };
    // id must be established after it's parameters are listed
    return id = navigator.geolocation.watchPosition(success, error, options);
  };

  // Sets up the ability to use geolocation from google maps
  geolocate = function() {
    return $.ajax({
      url: `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/js?key=${maps}`,
      cache: true,
      method: "GET"
    }).then(function(res) {
      // Gets coordinates and then runs yelp api with the results
      return getCoordinates();
    });
  };

  // Sends the info to be saved to the database for future searches
  sendInfo = function(id, name, picURL, yelp) {
    return $.post("/api/restaurants", {
      id: id,
      name: name,
      picURL: picURL,
      yelp: yelp
    }).then(function(res) {
      console.log(res);
      randomSelection();
      var id = selection[0].id;
      displayCard(id);
    });
  };

  // Gets the keys from server side
  getKeys = function() {
    return $.get("/api/keys", function(res) {
      yelp = `${res[0]}`;
      return maps = `${res[1]}`;
    });
  };

  // Sets the user's input to local storage in order to repeat search the same city
  // Might be redundant now with the new array method, in this case just move searchRestaurants() directly to the click event
  setCity = function() {
    var cities;
    if ($("#city").val().trim() !== "") {
      window.localStorage.clear();
      city = $("#city").val().trim();
      cities = [];
      cities.push($("#city").val().trim());
      localStorage.setItem("City", JSON.stringify(cities));
      return searchRestaurants();
    } else {
      return alert("You must enter a city! Or select nearby restaurants.");
    }
  };

  // Splices disliked restaurants from the database, and checks their logged date to see if they should re-enter the pool
  dislikedRestaurants = function() {
    return $.ajax({
      url: "/api/disliked",
      cache: true,
      method: "GET"
    }).then(function(res) {
      var count, countTwo, dislikedArray, removedArray, results;
      dislikedArray = res;
      console.log(dislikedArray);
      count = 0;
      countTwo = 0;
      results = [];
      while (count < dislikedArray.length) {
        while (countTwo < restaurantArray.length) {
          if (restaurantArray[countTwo].id === dislikedArray[count].id) {
            removedArray = removedArray + dislikedArray[count].splice();
          }
          countTwo++;
        }
        results.push(count++);
      }
      return results;
    });
  };

  
  // Randomly selects a restaurant from the generated array of restaurants
  randomSelection = function() {
    var random;
    random = Math.floor(Math.random() * restaurantArray.length);
    return selection = restaurantArray.splice(random, 1);
  };

  $(document).ready(function() {
    // Runs immediately to have info available before they start searching, prevents sync timing errors
    getKeys();
    $("#proximity").click(function(event) {
      if (JSON.parse(window.localStorage.getItem("Location Services")) !== true) {
        geoConfirm = confirm("This website is requesting your location to provide you with location based services.");
        if (geoConfirm === true) {
          localStorage.setItem("Location Services", JSON.stringify(geoConfirm));
          restaurantArray = [];
          return geolocate();
        } else if (geoConfirm === false) {
          return alert("Location services were denied, please enter a city.");
        }
      } else if (JSON.parse(window.localStorage.getItem("Location Services")) === true) {
        console.log("clicked and there is affirmation to geolocation");
        restaurantArray = [];
        return geolocate();
      }
    });
    return $("#search").click(function(event) {
      restaurantArray = [];
      event.preventDefault();
      setCity();
      return $("#city").val("");
    });
  });

}).call(this);
